<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ - BeBet</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="stylesheet" href="/css/layout.css">
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<body>
<div th:replace="layout/toastnotification.html :: toast(failed=${failed}, success=${success})"></div>

<div th:replace="layout/toastresponse.html :: toastresponse"></div>

<!-- Include sidebar from existing template -->
<div th:replace="layout/sidebar.html"></div>

<!--check login-->
<div th:replace="layout/checklogin.html"></div>

<!-- Page Content -->
<div id="content">
    <!-- Header -->
    <div class="app-header">
        <div class="header-left">
            <div class="page-title">Hồ sơ</div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Profile Section -->
        <div class="profile-section d-flex justify-content-between">
            <div class="profile-header">
                <div class="profile-avatar" >
                    <img th:src="${user.avatar}" alt="">
                </div>
                <div class="profile-info">
                    <div class="profile-title" th:text="'Danh hiệu: ' + ${title}">Danh hiệu: Người mới bắt đầu</div>
                    <div class="profile-username" th:text="'Người dùng: ' + ${user.userName}">Người dùng: user</div>
                    <div class="profile-email" th:text="'Email: ' + ${user.email}">Email: User@gmail.com</div>
                    <div class="gold-badge">
                        <img src="/images/coin-icon.png" alt="coin" class="coin-icon">
                        <span th:text="${user.coins} + ' Xu'">100 Xu</span>
                    </div>
                </div>
            </div>
            <button class="btn edit-profile-btn" id="editProfile">
                <i class="fas fa-edit"></i>
            </button>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <!-- Participating Challenges -->
            <div class="stat-card">
                <div class="stat-title">Thử Thách Đang Tham gia</div>
                <div class="stat-value" th:text="${participatingChallenges.size()}">12</div>
            </div>

            <!-- Longest Streak -->
            <div class="stat-card">
                <div class="stat-title">Streak dài nhất</div>
                <div class="stat-value" th:text="${longestStreakChallenge != null && longestStreakChallenge.bestStreak != null ? longestStreakChallenge.bestStreak : 0}">20</div>

                <div class="stat-subtitle" th:text="${longestStreakChallenge != null ? 'Của thử thách ' + longestStreakChallenge.challenge.title : ''}"></div>

            </div>

            <!-- Journal Entries -->
            <div class="stat-card">
                <div class="stat-title">Nhật ký</div>
                <div class="stat-value" th:text="${journalEntries.size()}">12</div>
                <div class="stat-subtitle">Bài viết</div>
            </div>

            <!-- Leaderboard Rank -->
            <div class="stat-card rank-card">
                <div class="stat-title">Thứ tự trên bảng xếp hạng</div>
                <div class="stat-value" th:text="${rankUser != null ? rankUser:'Chưa xếp hạng'}">12</div>
                <div class="stat-subtitle">Bảng xếp hạng các thử thách đã hoàn thành</div>
            </div>

            <!-- Completed Tasks -->
            <div class="stat-card">
                <div class="stat-title">Task đã hoàn thành từ khi tham gia</div>
                <div class="stat-value" th:text="${completedTask}">120</div>
            </div>

            <!-- Completed Challenges -->
            <div class="stat-card">
                <div class="stat-title">Thử Thách Đã hoàn thành</div>
                <div class="stat-value" th:text="${completedChallenges.size()}">5</div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 15px; border: none;">
            <div class="modal-header" style="background-color: #f8f9fa; border-bottom: none; padding: 25px 30px 15px;">
                <h4 class="modal-title fw-bold" id="editProfileModalLabel" style="color: #333;">Thông tin</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="font-size: 1.2rem;"></button>
            </div>
            <div class="modal-body" style="padding: 20px 30px 30px; background-color: #f8f9fa;">
                <!-- Profile Photo Section -->

                <form id="editProfileForm" th:action="@{/profile/update}" method="post" th:object="${newUser}" enctype="multipart/form-data">
                    <div class="text-center mb-4">
                        <div class="profile-photo-container position-relative d-inline-block">
                            <div class="profile-avatar">
                                <img th:src="${user.avatar}" alt="Avatar" id="avatarImg">
                            </div>
                            <!-- Input file để chọn ảnh -->
                            <input type="file" id="fileInput" style="display: none;" name="image" accept="image/*">
                        </div>
                        <div class="mt-2">
                            <a href="#" class="text-muted" style="font-size: 0.9rem; text-decoration: none;" onclick="document.getElementById('fileInput').click();">
                                <i class="fas fa-edit me-1"></i> Thay đổi
                            </a>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <input type="text" style="display: none" class="form-control edit-profile-input" id="userId" th:field="*{userId}" required>
                            <label for="editFirstName" class="form-label text-muted text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Người dùng</label>
                            <input type="text" class="form-control edit-profile-input" id="editFirstName" th:field="*{userName}" required>
                        </div>
<!--                        <div class="col-md-6">-->
<!--                            <label for="editLastName" class="form-label text-muted text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Last Name</label>-->
<!--                            <input type="text" class="form-control edit-profile-input" id="editLastName" th:text="${user.}"  required>-->
<!--                        </div>-->
                    </div>

                    <div class="mb-4">
                        <label for="editEmailAddress" class="form-label text-muted text-uppercase" style="font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px;">Địa chỉ Email</label>
                        <input type="email" readonly class="form-control edit-profile-input" id="editEmailAddress" th:field="*{email}"  required>
                    </div>

                    <div class="modal-footer" style="background-color: #f8f9fa; border-top: none; padding: 20px 30px 30px; justify-content: center; gap: 15px;">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal" style="background-color: white; border: 1px solid #dee2e6; color: #6c757d; padding: 12px 30px; border-radius: 25px; font-weight: 500; min-width: 120px;">
                            <i class="fas fa-times me-2"></i>Hủy
                        </button>
                        <button type="submit" class="btn btn-success" id="saveProfile" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; padding: 12px 30px; border-radius: 25px; font-weight: 500; min-width: 120px;">
                            <i class="fas fa-check me-2"></i>Lưu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit profile button
        document.getElementById('editProfile').addEventListener('click', function() {
            const editProfileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            editProfileModal.show();
        });

        // Open file input when 'Thay đổi' is clicked
        const changeAvatarButton = document.getElementById('changeAvatarButton');
        if (changeAvatarButton) {
            changeAvatarButton.addEventListener('click', function() {
                document.getElementById('fileInput').click(); // Kích hoạt input file
            });
        }

        // Lắng nghe sự kiện khi người dùng chọn ảnh
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(event) {
                previewImage(event);
            });
        }

        function previewImage(event) {
            const file = event.target.files[0];  // Lấy file đầu tiên từ danh sách file người dùng đã chọn
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Cập nhật ảnh lên thẻ <img> với ID avatarImg
                    document.getElementById('avatarImg').src = e.target.result;
                };
                reader.readAsDataURL(file);  // Chuyển file thành URL dữ liệu để hiển thị ảnh
            }
        }

        // Add hover effects to stat cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                const statValue = card.querySelector('.stat-value');
                statValue.style.color = '#007bff';
            });
            card.addEventListener('mouseleave', function() {
                const statValue = card.querySelector('.stat-value');
                if (!card.classList.contains('rank-card')) {
                    statValue.style.color = '#333';
                }
            });
        });

        // Animate numbers on page load
        animateNumbers();

        function animateNumbers() {
            const statValues = document.querySelectorAll('.stat-value');
            statValues.forEach(statValue => {
                const text = statValue.textContent;
                const number = parseInt(text.replace(/\D/g, ''));

                if (!isNaN(number)) {
                    statValue.textContent = '0';
                    let currentNumber = 0;

                    const interval = setInterval(() => {
                        currentNumber += Math.ceil(number / 150);
                        statValue.textContent = currentNumber;
                        if (currentNumber >= number) {
                            clearInterval(interval);
                        }
                    }, 10); // Adjust timing for smooth animation
                }
            });
        }
    });

</script>
</body>
</html>
