<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thử Thách - BeBet</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/css/challenge.css">
    <link rel="stylesheet" href="/css/layout.css">
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<body>

<div th:replace="layout/toastnotification.html :: toast(failed=${failed}, success=${success})"></div>

<div th:replace="layout/toastresponse.html :: toastresponse"></div>

<div th:replace="layout/sidebar.html"></div>

<!-- Page Content -->
<div id="content">
    <!-- Header -->
    <div class="row mx-0">
        <div class="col-md-12"><div th:replace="layout/userinformation.html :: user(user=${user})"></div></div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Add Challenge Button -->
        <button class="btn add-challenge-btn" onclick="openCreateChallengeModal()">
            <i class="fas fa-plus"></i> Thêm thử thách
        </button>

        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search">
                <button class="search-button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Challenges Section -->
        <div class="challenges-header" th:text="'Thử Thách Đang Tham Gia: ' + ${challenges.size()}">
            Thử Thách Đang Tham Gia: 4
        </div>

        <div class="challenges-grid">
            <div th:each="challenge : ${challenges}" class="challenge-card">
                <div class="challenge-name" th:text="${challenge.getChallenge().getTitle()}"></div>
                <div class="challenge-description" th:text="${challenge.getChallenge().getDescription()}">
                    Mô tả:
                </div>
                <div class="challenge-progress">
                    <span class="progress-text" th:text="'Ngày thực hiện: ' + ${challenge.getDaysSinceStart()} + '/' + ${challenge.getChallenge().getDay()}">
                        Ngày thực hiện:
                    </span>
                </div>
                <div class="streak-info">
                    <span th:text="'Chuỗi liên tiếp: ' + ${challenge.streak}">Chuỗi liên tiếp: </span><i class="fas fa-fire"></i>
                </div>
            </div>
        </div>
    </div>

    <!--Challenge Modal -->
    <div class="modal fade" id="ChallengeModal" tabindex="-1" aria-labelledby="ChallengeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header text-center p-0" style="background-color: #f7b924; color: #000;">
                    <h5 class="modal-title w-100 py-3 mb-0 fw-bold" id="ChallengeModalLabel"></h5>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="ChallengeForm" th:action="@{/challenges/save}" th:object="${newChallenge}" method="post" class="p-4">
                        <input type="hidden" id="challengeId" th:field="*{challengeId}">
                        <!-- Title -->
                        <div class="mb-3">
                            <label for="challengeTitle" class="form-label fw-bold">Tiêu đề</label>
                            <input type="text" class="form-control bg-light border-0" id="challengeTitle" th:field="*{title}" style="height: 45px; box-shadow: 0px 4px 5px 0px #dfdfdf">
                            <div id="challengeTitleError" class="text-danger mt-1" style="display: none;">Vui lòng nhập tiêu đề.</div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="challengeDescription" class="form-label fw-bold">Mô tả</label>
                            <textarea class="form-control bg-light border-0" id="challengeDescription" th:field="*{description}" rows="3" style="box-shadow: 0px 4px 5px 0px #dfdfdf;"></textarea>
                        </div>

                        <input type="hidden" id="habitsField" th:field="*{habits}" name="habits">
                        <input type="hidden" id="dailiesField" th:field="*{dailies}" name="dailies">

                        <div class="p-5">
                            <!-- End Date -->
                            <div class="mb-3">
                                <label for="challengeEndDate" class="form-label fw-bold">Ngày kết thúc</label>
                                <input type="date" class="form-control bg-light border-0" id="challengeEndDate" th:field="*{endDate}" style="height: 45px; box-shadow: 0px 4px 5px 0px #dfdfdf;">
                                <div id="challengeEndDateError" class="text-danger mt-1" style="display: none;">Vui lòng chọn ngày hợp lệ.</div>
                            </div>

                            <!-- Duration -->
                            <div class="mb-4">
                                <div class="col-md-12">
                                    <label for="challengeDuration" class="form-label fw-bold">Số ngày thực hiện thử thách</label>
                                    <div class="input-group" style="box-shadow: 0px 4px 5px 0px #dfdfdf;">
                                        <input type="number" class="form-control bg-light border-0" id="challengeDuration" th:field="*{day}" style="height: 45px; " readonly>
                                        <span class="btn btn-secondary disabled" style="height: 45px; line-height: 33px;">Ngày</span>
                                    </div>
                                    <div id="challengeDurationError" class="text-danger mt-1" style="display: none">Số ngày thực hiện phải > 5 ngày</div>
                                </div>
                            </div>

                            <!-- Daily Tasks Section -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Thói quen hàng ngày</label>
                                <div class="bg-light p-3 rounded">
                                    <button type="button" class="btn btn-light border mb-3 w-100 text-start" id="addDailyTaskBtn" data-bs-target="#modalDaily">
                                        <i class="fas fa-plus me-2"></i>Thêm công việc
                                    </button>
                                    <div id="dailyTasksList"></div>
                                </div>
                            </div>

                            <!-- Habits Section -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Thói quen</label>
                                <div class="bg-light p-3 rounded">
                                    <button type="button" class="btn btn-light border mb-3 w-100 text-start" id="addHabitBtn" data-bs-target="#modalHabit">
                                        <i class="fas fa-plus me-2"></i>Thêm công việc
                                    </button>
                                    <div id="habitsList"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveChallengeBtn">Lưu</button>
                    <button type="button" class="btn btn-success" id="shareChallengeBtn" style="display: none;">Chia sẻ thử thách</button>
                </div>
            </div>
        </div>
    </div>



    <!--modal daily-->
    <div class="modal fade" id="modalDaily" style="background-color: #b0b0b073;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="dailyForm">
                    <div class="modal-header text-bg-warning p-4">
                        <div class="w-100">
                            <h4 id="DailyModalTitle" class="fw-bold mb-3">Tạo mới Daily</h4>
                            <input type="hidden" id="dailyId" />
                            <div class="mb-3">
                                <label for="dailyTitle" class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="dailyTitle">
                                <div id="dailyTitleError" class="text-danger mt-1" style="display: none;">Vui lòng nhập tiêu đề.</div>
                            </div>
                            <div class="mb-3">
                                <label for="dailyDes" class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="dailyDes" rows="3" placeholder="Thêm ghi chú"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Difficulty -->
                        <div class="mb-3">
                            <label for="dailyDifficulty" class="form-label">Độ khó</label>
                            <select class="form-control" id="dailyDifficulty">
                                <option value="EASY">Dễ</option>
                                <option value="MEDIUM">Trung bình</option>
                                <option value="HARD">Khó</option>
                            </select>
                        </div>

                        <!-- Repeat Frequency -->
                        <div class="mb-3">
                            <label for="repeatFrequency" class="form-label">Tần suất lặp lại</label>
                            <select class="form-control" id="repeatFrequency">
                                <option value="DAILY">Hàng ngày</option>
                                <option value="WEEKLY">Hàng tuần</option>
                                <option value="MONTHLY">Hàng tháng</option>
                            </select>
                        </div>

                        <!-- Repeat Every -->
                        <div class="mb-3" id="repeatEverySection" style="display: none">
                            <label for="repeatEvery" class="form-label">Lặp lại sau mỗi</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="repeatEvery" min="1" />
                                <span class="input-group-text" id="repeatEveryUnit">Days</span>
                            </div>
                            <div id="repeatEveryError" class="text-danger mt-1" style="display: none;">Vui lòng nhập giá trị lớn hơn 0.</div>
                        </div>

                        <!-- Repeat Days (Weekly) -->
                        <div class="mb-3" id="repeatDaysSection" style="display: none;">
                            <label class="form-label">Lặp lại vào</label>
                            <div th:each="dayofweek : ${daysOfWeek}" style="width: 100%">
                                <div class="form-check form-check-inline" style="width: 20%">
                                    <input class="form-check-input" type="checkbox" th:value="${dayofweek}" th:id="|day-${dayofweek}|">
                                    <label class="form-check-label" th:for="|day-${dayofweek}|" th:text="${dayofweek}">SUNDAY</label>
                                </div>
                            </div>
                            <div id="repeatDaysError" class="text-danger mt-1" style="display: none;">Vui lòng chọn ít nhất 1 ngày.</div>
                        </div>

                        <!-- Repeat Month Days (Monthly) -->
                        <div class="mb-3" id="repeatMonthDaysSection" style="display: none;">
                            <label class="form-label">Lặp lại vào ngày</label>
                            <div class="d-flex flex-wrap gap-2" style="max-height: 150px; width: 100%; overflow-y: auto;">
                                <div th:each="day : ${#numbers.sequence(1, 31)}" class="form-check form-check-inline" style="width: 14%" th:data-day="${day}">
                                    <input class="form-check-input" type="checkbox" value="${day}" th:id="|month-day-${day}|" />
                                    <label class="form-check-label" th:for="|month-day-${day}|" th:text="${day}">1</label>
                                </div>
                            </div>
                            <div id="repeatMonthDaysError" class="text-danger mt-1" style="display: none;">Vui lòng chọn ít nhất 1 ngày trong tháng.</div>
                        </div>

                        <div class="modal-footer d-flex justify-content-end">
                            <div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="submit" class="btn btn-primary">Lưu</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!--modal habit-->
    <div class="modal fade" id="modalHabit" style="background-color: #b0b0b073;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="habitForm">
                    <div class="modal-header text-bg-warning p-4">
                        <div class="w-100">
                            <h4 id="habitContent" class="fw-bold mb-3">Tạo mới</h4>
                            <input type="hidden" id="habitId">
                            <div class="mb-3">
                                <label for="habitTitle" class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="habitTitle">
                                <div id="habitTitleError" class="text-danger mt-1" style="display: none;">Vui lòng nhập tiêu đề.</div>
                            </div>
                            <div class="mb-3">
                                <label for="habitDescription" class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="habitDescription" rows="3" placeholder="Thêm ghi chú"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label for="habitType" class="form-label">Loại</label>
                            <select class="form-control" id="habitType">
                                <option value="BOTH">Tích cực/Tiêu cực</option>
                                <option value="POSITIVE">Tích cực</option>
                                <option value="NEGATIVE">Tiêu cực</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="habitDifficulty" class="form-label">Độ khó</label>
                            <select class="form-control" id="habitDifficulty">
                                <option value="EASY">Dễ</option>
                                <option value="MEDIUM">Trung bình</option>
                                <option value="HARD">Khó</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="habitTarget" class="form-label">Mục tiêu</label>
                            <input type="number" class="form-control" id="habitTarget">
                            <div id="habitTargetError" class="text-danger mt-1" style="display: none;">Vui lòng chọn mục tiêu >1</div>
                        </div>

                        <div class="modal-footer d-flex justify-content-between">
                            <div></div>
                            <div>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="submit" class="btn btn-primary">Lưu</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Mở modal tạo thử thách
        window.openCreateChallengeModal = function() {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('sv-SE');
            document.getElementById("challengeTitle").value = '';
            document.getElementById("challengeDescription").value = '';
            document.getElementById("challengeEndDate").value = formattedDate;
            document.getElementById("challengeDuration").value = '1';
            document.getElementById("dailyTasksList").innerHTML = '';
            document.getElementById("habitsList").innerHTML = '';

            const formChallenge = document.getElementById("ChallengeForm");
            const ChallengeTitleModal = document.getElementById("ChallengeModalLabel");

            formChallenge.action = '/challenges/save';
            ChallengeTitleModal.textContent = "Tạo thử thách mới";

            const modalChallenge = new bootstrap.Modal(document.getElementById("ChallengeModal"));
            modalChallenge.show();
        };

        const challengeEndDate = document.getElementById("challengeEndDate");
        const challengeTitleInput = document.getElementById("challengeTitle");
        const challengeTitleError = document.getElementById("challengeTitleError");
        const challengeEndDateError = document.getElementById("challengeEndDateError");
        const challengeDurationInput = document.getElementById("challengeDuration");
        const saveChallengeBtn = document.getElementById("saveChallengeBtn");
        const shareChallengeBtn = document.getElementById("shareChallengeBtn");
        const challengeDurationError = document.getElementById("challengeDurationError")

        let habitsList = [];
        let dailiesList = [];

        challengeEndDate.addEventListener("change", function() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const end = new Date(challengeEndDate.value);
            end.setHours(0, 0, 0, 0);

            if (end && end >= today) {
                const days = Math.ceil((end - today) / (1000 * 60 * 60 * 24)) + 1;
                challengeDurationInput.value = days;
                challengeEndDateError.style.display = "none";
            } else {
                challengeDurationInput.value = "";
                challengeEndDateError.style.display = "block";
            }
        });

        function addHabitToList(habit) {
            let hiddenPositive = "block";
            let hiddenNegative = "block";
            if(habit.type === "POSITIVE"){
                hiddenNegative = "none"
            }else if(habit.type === "NEGATIVE"){
                hiddenPositive = "none"
            }
            const habitItem = document.createElement("div");
            habitItem.className = "habit-item mb-2";
            habitItem.innerHTML = `
            <div class="bg-white p-2 rounded d-flex justify-content-between align-items-center" style="box-shadow: 0px 4px 5px 0px #dfdfdf;">
                <span>${habit.title}</span>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm rounded-circle me-2" style="display: ${hiddenPositive}; background-color: #28a745; width: 25px; height: 25px;"></button>
                    <button type="button" class="btn btn-sm rounded-circle me-2" style="display: ${hiddenNegative}; background-color: #dc3545; width: 25px; height: 25px;"></button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeHabit(this, ${habitsList.length})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>`;
            document.getElementById("habitsList").appendChild(habitItem);
            habitsList.push(habit);
            document.getElementById("habitsField").value = JSON.stringify(habitsList);

        }
        function addDailyToList(daily) {
            const dailyItem = document.createElement("div");
            dailyItem.className = "daily-task-item mb-2";
            dailyItem.innerHTML = `
            <div class="bg-white p-2 rounded d-flex justify-content-between align-items-center" style="box-shadow: 0px 4px 5px 0px #dfdfdf;">
                <span>${daily.title}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDailyTask(this, ${dailiesList.length})">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
            document.getElementById("dailyTasksList").appendChild(dailyItem);
            dailiesList.push(daily);
            document.getElementById("dailiesField").value = JSON.stringify(dailiesList);
        }

        window.removeHabit = function(element, index) {
            habitsList.splice(index, 1);
            element.closest(".habit-item").remove();
            document.getElementById("habitsField").value = JSON.stringify(habitsList);
        };

        window.removeDailyTask = function(element, index) {
            dailiesList.splice(index, 1);
            element.closest(".daily-task-item").remove();
            document.getElementById("dailiesField").value = JSON.stringify(dailiesList);
        };

        // Xử lý mở modal Habit và validate dữ liệu
        document.getElementById("addHabitBtn").addEventListener("click", ()=> {
            document.getElementById("habitTitle").value = '';
            document.getElementById("habitDescription").value = '';
            document.getElementById("habitType").value = 'POSITIVE';
            document.getElementById("habitDifficulty").value = 'EASY';
            document.getElementById("habitTarget").value = '1';
            document.getElementById("habitTitleError").style.display = 'none';
            document.getElementById("habitTargetError").style.display = 'none';

            const habitModal = new bootstrap.Modal(document.getElementById("modalHabit"));
            habitModal.show();

            document.getElementById("habitForm").onsubmit = (e)=>{
                e.preventDefault();
                let valid = true;

                const title = document.getElementById("habitTitle").value;
                const description = document.getElementById("habitDescription").value;
                const type = document.getElementById("habitType").value;
                const difficulty = document.getElementById("habitDifficulty").value;
                const targetCount = document.getElementById("habitTarget").value;

                if (!title || title.trim() === "") {
                    document.getElementById("habitTitleError").style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById("habitTitleError").style.display = 'none';
                }

                if (!targetCount || targetCount <= 1) {
                    document.getElementById("habitTargetError").style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById("habitTargetError").style.display = 'none';
                }

                if (valid) {
                    const habit = { title, description, type, difficulty, targetCount: parseInt(targetCount) };
                    console.log(habit)
                    addHabitToList(habit);
                    habitModal.hide();
                }
            };
        });

        // Xử lý mở modal Daily và validate dữ liệu
        document.getElementById("addDailyTaskBtn").addEventListener("click", ()=> {
            document.getElementById("dailyTitle").value = '';
            document.getElementById("dailyDes").value = '';
            document.getElementById("dailyDifficulty").value = 'EASY';
            document.getElementById("repeatFrequency").value = 'DAILY';
            document.getElementById("repeatEvery").value = '1';
            document.getElementById("dailyTitleError").style.display = 'none';
            document.getElementById("repeatEveryError").style.display = 'none';
            document.getElementById("repeatDaysError").style.display = 'none';
            document.getElementById("repeatMonthDaysError").style.display = 'none';

            const repeatFrequency = document.getElementById("repeatFrequency");
            const repeatEverySection = document.getElementById("repeatEverySection");
            const repeatDaysSection = document.getElementById("repeatDaysSection");
            const repeatMonthDaysSection = document.getElementById("repeatMonthDaysSection");

            function updateRepeatSections() {
                const freq = repeatFrequency.value;
                repeatEverySection.style.display = freq === 'DAILY' ? 'block' : 'none';
                repeatDaysSection.style.display = freq === 'WEEKLY' ? 'block' : 'none';
                repeatMonthDaysSection.style.display = freq === 'MONTHLY' ? 'block' : 'none';
                document.getElementById("repeatEveryUnit").textContent = freq === 'DAILY' ? 'Days' : freq === 'WEEKLY' ? 'Weeks' : 'Months';
            }

            repeatFrequency.addEventListener("change", updateRepeatSections);
            updateRepeatSections();

            const dailyModal = new bootstrap.Modal(document.getElementById("modalDaily"));
            dailyModal.show();

            document.getElementById("dailyForm").onsubmit = (e)=> {
                e.preventDefault();
                let valid = true;

                const title = document.getElementById("dailyTitle").value;
                const description = document.getElementById("dailyDes").value;
                const difficulty = document.getElementById("dailyDifficulty").value;
                const repeatFrequency = document.getElementById("repeatFrequency").value;
                const repeatEvery = document.getElementById("repeatEvery").value;
                const repeatDays = Array.from(document.querySelectorAll("#repeatDaysSection input:checked")).map(input => input.value);
                const repeatMonthDays = Array.from(document.querySelectorAll("#repeatMonthDaysSection input:checked")).map(input => parseInt(input.value));

                if (!title || title.trim() === "") {
                    document.getElementById("dailyTitleError").style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById("dailyTitleError").style.display = 'none';
                }

                if (!repeatEvery || repeatEvery <= 0) {
                    document.getElementById("repeatEveryError").style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById("repeatEveryError").style.display = 'none';
                }

                if (repeatFrequency === 'WEEKLY' && repeatDays.length === 0) {
                    document.getElementById("repeatDaysError").style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById("repeatDaysError").style.display = 'none';
                }

                if (repeatFrequency === 'MONTHLY' && repeatMonthDays.length === 0) {
                    document.getElementById("repeatMonthDaysError").style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById("repeatMonthDaysError").style.display = 'none';
                }

                if (valid) {
                    const daily = {
                        title,
                        description,
                        difficulty,
                        repeatFrequency,
                        repeatEvery: parseInt(repeatEvery),
                        repeatDays: repeatFrequency === 'WEEKLY' ? repeatDays : [],
                        repeatMonthDays: repeatFrequency === 'MONTHLY' ? repeatMonthDays : []
                    };
                    addDailyToList(daily);
                    dailyModal.hide();
                }
            };
        });

        saveChallengeBtn.addEventListener("click", function() {
            let valid = true;
            if (challengeTitleInput.value.trim() === "") {
                challengeTitleError.style.display = "block";
                valid = false;
            } else {
                challengeTitleError.style.display = "none";
            }

            // Validate ngày kết thúc
            if (!challengeEndDate.value || new Date(challengeEndDate.value) < new Date()) {
                challengeEndDateError.style.display = "block";
                valid = false;
            } else {
                challengeEndDateError.style.display = "none";
            }

            if(challengeDurationInput.value <=4 || !challengeDurationInput.value){
                challengeDurationError.style.display = "block";
                valid=false;
            }else{
                challengeDurationError.style.display = "none";
            }

            if (!valid) return;

            document.getElementById("ChallengeForm").submit();
        });

        shareChallengeBtn.addEventListener("click", function() {
            const challengeId = document.getElementById("challengeId").value;
            if (!challengeId) {
                alert("Vui lòng chọn một thử thách để chia sẻ!");
                return;
            }

            fetch(`/challenges/complete/${challengeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        $('#ChallengeModal').modal('hide');
                        loadCompletedChallenges();
                    } else {
                        alert("Lỗi: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Đã có lỗi xảy ra!");
                });
        });

        function loadCompletedChallenges() {
            fetch('/challenges/completed', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        console.log("Completed Challenges:", data);
                        displayCompletedChallenges(data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function displayCompletedChallenges(challenges) {
            const container = document.getElementById("completedChallengesList") || document.createElement("div");
            container.id = "completedChallengesList";
            container.innerHTML = "";
            challenges.forEach(challenge => {
                const div = document.createElement("div");
                div.className = "challenge-card mb-2 p-2 border";
                div.innerHTML = `<span>${challenge.title} (Hoàn thành: ${challenge.endDate})</span>`;
                container.appendChild(div);
            });
            document.body.appendChild(container);
        }

        function checkChallengeCompletion() {
            const challengeId = document.getElementById("challengeId").value;
            if (challengeId) {
                fetch(`/challenges/complete/check/${challengeId}`, {
                    method: 'GET'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.completed) {
                            shareChallengeBtn.style.display = "block";
                        } else {
                            shareChallengeBtn.style.display = "none";
                        }
                    });
            }
        }

        $('#ChallengeModal').on('shown.bs.modal', checkChallengeCompletion);
    });

        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('keyup', function () {
                const searchTerm = searchInput.value.toLowerCase();
                const challengeCards = document.querySelectorAll('.challenge-card');

                challengeCards.forEach(function (card) {
                    const challengeNameElem = card.querySelector('.challenge-name');
                    const challengeName = challengeNameElem ? challengeNameElem.textContent.toLowerCase() : "";

                    if (challengeName.includes(searchTerm)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        // Challenge card click
        const challengeCards = document.querySelectorAll('.challenge-card');
        challengeCards.forEach(function (card) {
            card.addEventListener('click', function () {
                const challengeNameElem = card.querySelector('.challenge-name');
                const challengeName = challengeNameElem ? challengeNameElem.textContent : "Không rõ";
                console.log('Clicked on challenge:', challengeName);
            });
        });



</script>
</body>
</html>
